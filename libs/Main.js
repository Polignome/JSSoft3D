const TEST ="       \n\
# Blender 4.5.1 LTS \n\
# www.blender.org\n\
mtllib smalercity.mtl\n\
o Cube\n\
v 0.700830 1.237962 -0.936571\n\
v 0.700830 -0.762038 -0.936571\n\
v 0.700830 1.237962 1.063429\n\
v 0.700830 -0.762038 1.063429\n\
v -1.299170 1.237962 -0.936571\n\
v -1.299170 -0.762038 -0.936571\n\
v -1.299170 1.237962 1.063429\n\
v -1.299170 -0.762038 1.063429\n\
vn -0.0000 1.0000 -0.0000\n\
vn -0.0000 -0.0000 1.0000\n\
vn -1.0000 -0.0000 -0.0000\n\
vn -0.0000 -1.0000 -0.0000\n\
vn 1.0000 -0.0000 -0.0000\n\
vn -0.0000 -0.0000 -1.0000\n\
vt 0.625000 0.500000\n\
vt 0.875000 0.500000\n\
vt 0.875000 0.750000\n\
vt 0.625000 0.750000\n\
vt 0.375000 0.750000\n\
vt 0.625000 1.000000\n\
vt 0.375000 1.000000\n\
vt 0.375000 0.000000\n\
vt 0.625000 0.000000\n\
vt 0.625000 0.250000\n\
vt 0.375000 0.250000\n\
vt 0.125000 0.500000\n\
vt 0.375000 0.500000\n\
vt 0.125000 0.750000\n\
s 0\n\
usemtl Material\n\
f 1/1/1 5/2/1 7/3/1 3/4/1\n\
f 4/5/2 3/4/2 7/6/2 8/7/2\n\
f 8/8/3 7/9/3 5/10/3 6/11/3\n\
f 6/12/4 2/13/4 4/5/4 8/14/4\n\
f 2/13/5 1/1/5 3/4/5 4/5/5\n\
f 6/11/6 5/10/6 1/1/6 2/13/6\n\
o Cube.001\n\
v 1.969569 1.326292 -52.618359\n\
v 1.969569 -0.673708 -52.618359\n\
v 1.969569 1.326292 53.378971\n\
v 1.969569 -0.673708 53.378971\n\
v -0.030431 1.326292 -52.618359\n\
v -0.030431 -0.673708 -52.618359\n\
v -0.030431 1.326292 53.378971\n\
v -0.030431 -0.673708 53.378971\n\
vn -0.0000 1.0000 -0.0000\n\
vn -0.0000 -0.0000 1.0000\n\
vn -1.0000 -0.0000 -0.0000\n\
vn -0.0000 -1.0000 -0.0000\n\
vn 1.0000 -0.0000 -0.0000\n\
vn -0.0000 -0.0000 -1.0000\n\
vt 0.625000 0.500000\n\
vt 0.875000 0.500000\n\
vt 0.875000 0.750000\n\
vt 0.625000 0.750000\n\
vt 0.375000 0.750000\n\
vt 0.625000 1.000000\n\
vt 0.375000 1.000000\n\
vt 0.375000 0.000000\n\
vt 0.625000 0.000000\n\
vt 0.625000 0.250000\n\
vt 0.375000 0.250000\n\
vt 0.125000 0.500000\n\
vt 0.375000 0.500000\n\
vt 0.125000 0.750000\n\
s 0\n\
usemtl Material\n\
f 9/15/7 13/16/7 15/17/7 11/18/7\n\
f 12/19/8 11/18/8 15/20/8 16/21/8\n\
f 16/22/9 15/23/9 13/24/9 14/25/9\n\
f 14/26/10 10/27/10 12/19/10 16/28/10\n\
f 10/27/11 9/15/11 11/18/11 12/19/11\n\
f 14/25/12 13/24/12 9/15/12 10/27/12\n\
o Cube.002\n\
v -1.648434 3.711225 1.333802\n\
v -1.648434 1.711224 1.333802\n\
v -1.648434 3.711225 3.333802\n\
v -1.648434 1.711224 3.333802\n\
v -3.648434 3.711225 1.333802\n\
v -3.648434 1.711224 1.333802\n\
v -3.648434 3.711225 3.333802\n\
v -3.648434 1.711224 3.333802\n\
vn -0.0000 1.0000 -0.0000\n\
vn -0.0000 -0.0000 1.0000\n\
vn -1.0000 -0.0000 -0.0000\n\
vn -0.0000 -1.0000 -0.0000\n\
vn 1.0000 -0.0000 -0.0000\n\
vn -0.0000 -0.0000 -1.0000\n\
vt 0.625000 0.500000\n\
vt 0.875000 0.500000\n\
vt 0.875000 0.750000\n\
vt 0.625000 0.750000\n\
vt 0.375000 0.750000\n\
vt 0.625000 1.000000\n\
vt 0.375000 1.000000\n\
vt 0.375000 0.000000\n\
vt 0.625000 0.000000\n\
vt 0.625000 0.250000\n\
vt 0.375000 0.250000\n\
vt 0.125000 0.500000\n\
vt 0.375000 0.500000\n\
vt 0.125000 0.750000\n\
s 0\n\
usemtl Material\n\
f 17/29/13 21/30/13 23/31/13 19/32/13\n\
f 20/33/14 19/32/14 23/34/14 24/35/14\n\
f 24/36/15 23/37/15 21/38/15 22/39/15\n\
f 22/40/16 18/41/16 20/33/16 24/42/16\n\
f 18/41/17 17/29/17 19/32/17 20/33/17\n\
f 22/39/18 21/38/18 17/29/18 18/41/18\n\
o Cube.003\n\
v -0.030253 4.447314 -3.237099\n\
v -0.030253 2.447314 -3.237099\n\
v -0.030253 4.447314 -1.237099\n\
v -0.030253 2.447314 -1.237099\n\
v -2.030253 4.447314 -3.237099\n\
v -2.030253 2.447314 -3.237099\n\
v -2.030253 4.447314 -1.237099\n\
v -2.030253 2.447314 -1.237099\n\
vn -0.0000 1.0000 -0.0000\n\
vn -0.0000 -0.0000 1.0000\n\
vn -1.0000 -0.0000 -0.0000\n\
vn -0.0000 -1.0000 -0.0000\n\
vn 1.0000 -0.0000 -0.0000\n\
vn -0.0000 -0.0000 -1.0000\n\
vt 0.625000 0.500000\n\
vt 0.875000 0.500000\n\
vt 0.875000 0.750000\n\
vt 0.625000 0.750000\n\
vt 0.375000 0.750000\n\
vt 0.625000 1.000000\n\
vt 0.375000 1.000000\n\
vt 0.375000 0.000000\n\
vt 0.625000 0.000000\n\
vt 0.625000 0.250000\n\
vt 0.375000 0.250000\n\
vt 0.125000 0.500000\n\
vt 0.375000 0.500000\n\
vt 0.125000 0.750000\n\
s 0\n\
usemtl Material\n\
f 25/43/19 29/44/19 31/45/19 27/46/19\n\
f 28/47/20 27/46/20 31/48/20 32/49/20\n\
f 32/50/21 31/51/21 29/52/21 30/53/21\n\
f 30/54/22 26/55/22 28/47/22 32/56/22\n\
f 26/55/23 25/43/23 27/46/23 28/47/23\n\
f 30/53/24 29/52/24 25/43/24 26/55/24\n\
o Cube.004\n\
v -0.037303 -0.204773 2.512850\n\
v -0.037303 -2.204772 2.512850\n\
v -0.037303 -0.204773 4.512850\n\
v -0.037303 -2.204772 4.512850\n\
v -2.037303 -0.204773 2.512850\n\
v -2.037303 -2.204772 2.512850\n\
v -2.037303 -0.204773 4.512850\n\
v -2.037303 -2.204772 4.512850\n\
vn -0.0000 1.0000 -0.0000\n\
vn -0.0000 -0.0000 1.0000\n\
vn -1.0000 -0.0000 -0.0000\n\
vn -0.0000 -1.0000 -0.0000\n\
vn 1.0000 -0.0000 -0.0000\n\
vn -0.0000 -0.0000 -1.0000\n\
vt 0.625000 0.500000\n\
vt 0.875000 0.500000\n\
vt 0.875000 0.750000\n\
vt 0.625000 0.750000\n\
vt 0.375000 0.750000\n\
vt 0.625000 1.000000\n\
vt 0.375000 1.000000\n\
vt 0.375000 0.000000\n\
vt 0.625000 0.000000\n\
vt 0.625000 0.250000\n\
vt 0.375000 0.250000\n\
vt 0.125000 0.500000\n\
vt 0.375000 0.500000\n\
vt 0.125000 0.750000\n\
s 0\n\
usemtl Material\n\
f 33/57/25 37/58/25 39/59/25 35/60/25\n\
f 36/61/26 35/60/26 39/62/26 40/63/26\n\
f 40/64/27 39/65/27 37/66/27 38/67/27\n\
f 38/68/28 34/69/28 36/61/28 40/70/28\n\
f 34/69/29 33/57/29 35/60/29 36/61/29\n\
f 38/67/30 37/66/30 33/57/30 34/69/30\n\
";










const width = 320*2;
const height = 200*2;
var now = new Date();
var oldTime;
var time;
var frameTime;
var canvas = new Canvas("canvas",width,height);
var rasterizer = new Rasterizer(canvas);

var keys= new Array(256);
var prekeys= new Array(256);
var polys=new Array();
var obj3d = new IndexedObject();

var spansin=0;
var spansout=0;
////////////////////////////////////
var mouse_key=0;
var mouse_posx=0;
var mouse_posy=0;
var mouse_posx_old=0;
var mouse_posy_old=0;
var mouse_posx_div=0;
var mouse_posy_div=0;
////////////////////////////////////

var use_timer = false;

var lastCalledTime;
var fps=0;
//var meter = new FPSMeter();

var meter = new FPSMeter(document.getElementById('render'), { graph: 2 });

////////////////////////////////////
var render_zbuffer =false;
var cam = new Camera();
var m_last_key_down=0;
var m_render_zbuffer =false;
var m_use_spanbuffer =true;
var m_show_fps=true;
const MOUSE_BUTTON_LEFT = 1<<1;
const MOUSE_BUTTON_MIDDLE = 1<<2;
const MOUSE_BUTTON_RIGHT = 1<<3
var bsp=null;


var cube_verts=new Array(
new Vector3(-1,1,-1),new Vector3(1,1,-1),new Vector3(1,-1,-1),new Vector3(-1,-1,-1),
new Vector3(1,1,-1),new Vector3(1,1,1),new Vector3(1,-1,1),new Vector3(1,-1,-1),
new Vector3(1,1,1),new Vector3(-1,1,1),new Vector3(-1,-1,1),new Vector3(1,-1,1),
new Vector3(-1,1,1),new Vector3(-1,1,-1),new Vector3(-1,-1,-1),new Vector3(-1,-1,1),
new Vector3(-1,1,-1),new Vector3(-1,1,1),new Vector3(1,1,1),new Vector3(1,1,-1),
new Vector3(-1,-1,-1),new Vector3(1,-1,-1),new Vector3(1,-1,1),new Vector3(-1,-1,1));

var cube_indices=new Array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23);




function CreateCube(pos=new Vector3(0,0,0),type=POLY_FILLED,scale=new Vector3(1,1,1),rot=new Vector3(0,0,0)) {

    var polygons_list= new Array();

	
	var v1=new Array(new Vector3(-1,1,-1),new Vector3(1,1,-1),new Vector3(1,-1,-1),new Vector3(-1,-1,-1));
	var v2=new Array(new Vector3(1,1,-1),new Vector3(1,1,1),new Vector3(1,-1,1),new Vector3(1,-1,-1));
	var v3=new Array(new Vector3(1,1,1),new Vector3(-1,1,1),new Vector3(-1,-1,1),new Vector3(1,-1,1));
	var v4=new Array(new Vector3(-1,1,1),new Vector3(-1,1,-1),new Vector3(-1,-1,-1),new Vector3(-1,-1,1));
	var v5=new Array(new Vector3(-1,1,-1),new Vector3(-1,1,1),new Vector3(1,1,1),new Vector3(1,1,-1));
	var v6=new Array(new Vector3(-1,-1,-1),new Vector3(1,-1,-1),new Vector3(1,-1,1),new Vector3(-1,-1,1));
	var h= new Array(v1,v2,v3,v4,v5,v6);
	

	



    for (let i=0;i<h.length;i++) {
		for (let j=0;j<h[i].length;j++) {
			h[i][j]=h[i][j].mul(scale);
			h[i][j]=h[i][j].add(pos);
		}
	}



	for (let i=0;i<h.length;i++)
	{
	  var p=new Polygon(h[i]);
	 p.render_type=POLY_PERSPECTIVE_TEXTURED;
	  p.calcPlane(); 
	  //zzp.setWorldTexture(1,1);
	  p.setPlanarTexture();
	  p.SetNormalColor(1,1,1); 
	  polygons_list.push(p);
	  
	}

	return polygons_list;

}

function InitCamera() {
	let	FOV =  60;
	cam.aspect  = ( width * 1) / ( height* 1); 
	cam.fov     = FOV *  3.14159265359 /  180;
	cam.near    = 0.001;
	cam.far     = 1000;
	cam.LookAt(new Vector3(0,0,0));
	cam.position= new Vector3(0,0,-10);
}

function Sig(key) {
}

function SetMousePos(x,y) {
	mouse_posx_old=mouse_posx;
	mouse_posy_old=mouse_posy;
	mouse_posx=x;
	mouse_posy=y;
	mouse_posx_div=mouse_posx-mouse_posx_old;
	mouse_posy_div=mouse_posy-mouse_posy_old;
}

function WriteToLog(s) {
    var logElement=document.getElementById("log");
	for (var i=0;i<s.length;i++) 
	{
		if (s[i]=="\b") {logElement.innerHTML="";continue;}
		if (s[i]=="\n") {logElement.innerHTML+="<br/>"; continue;}
		logElement.innerHTML+=s[i]; 
	}
}

function Render() {
	rasterizer.RenderPrimitives();
    rasterizer.Render();
    spansin=rasterizer.SpansIn;
    spansout=rasterizer.SpansOut;
	
}


function UpdateKeys() {
	
	


	if (keys[(90)]) {m_render_zbuffer=true;}
	if (keys[(85)]) {m_render_zbuffer=false;}




	if (keys[(87)]) {cam.Move(0,-3);}
    if (keys[(83)]) {cam.Move(0,3);}
    if (keys[(65)]) {cam.Move(3,0);}
    if (keys[(68)]) {cam.Move(-3,0);}

}

function dec2bin(dec) {
  return (dec >>> 0).toString(2);
}

function ProBar(ist,max,len=20) {
	
	
	
	
	let p=ist/max;
	let pl=p*len;
	let s="|"
	for (let i=0;i<len;i++) {
	   if (i<=pl)s+='#'; else s+='_';		
	}
    s+="| "+Math.round((p*100))+"%";
	return s;
}


function UpdateMouse() {

	if (mouse_key !=0) {
		cam.Turn(mouse_posy_div*18,-mouse_posx_div*18);
		mouse_posx_div=0;
		mouse_posy_div=0;
	}

	
    
	WriteToLog("FPS............................: "+(fps|0)+"\n");
	WriteToLog("MouseKey ......................: "+mouse_key+"\n");
	WriteToLog("MousePos ......................: "+mouse_posx+","+mouse_posy+"\n");
	WriteToLog("MousePos_old ..................: "+mouse_posx_old+","+mouse_posy_old+"\n");
	WriteToLog("MousePos_div ..................: "+mouse_posx_div+","+mouse_posy_div+"\n\n");
    var stat=rasterizer.getStatistic();
    let node_count =rasterizer._bhv.total_node_count;      
	let help =node_count; 
														 
     WriteToLog("Primsives in:..................: "+stat.primitives_in+"\n");
     WriteToLog("Total node counter.............: "+node_count+"\n");
     WriteToLog("Mode hzb culled:...............: "+ProBar(stat.mode_hzb_culled,help)+" "+stat.mode_hzb_culled+"\n"); help-=stat.node_aabb_frustum_culled;
	 WriteToLog("Node aabb frustum culled:......: "+ProBar(stat.node_aabb_frustum_culled,help)+" "+stat.node_aabb_frustum_culled+"\n"); help-=stat.node_aabb_project_culled;
     WriteToLog("Node_aabb_project_culled:......: "+ProBar(stat.node_aabb_project_culled,help)+" "+stat.node_aabb_project_culled+"\n");
      help =rasterizer._bhv.nodes_checkt;      
	 WriteToLog("Nodes checked...........:......: "+ProBar(help,node_count)+" "+help+"\n");
	 let status=stat.primitives_in;
     WriteToLog("Primitives_back_face_culling...: "+ProBar(stat.primitives_back_face_culling,status)+" "+stat.primitives_back_face_culling+"\n");
	 status-=stat.primitives_frustum_culling;
     WriteToLog("Primitives_frustum_culling.....: "+ProBar(stat.primitives_frustum_culling,status)+" "+stat.primitives_frustum_culling+"\n");
	 status-=stat.primitives_transform_culling;
     WriteToLog("Primitives_transform_culling...: "+ProBar(stat.primitives_transform_culling,status)+" "+stat.primitives_transform_culling+"\n");
	 status-=stat.primitives_project_culling;
     WriteToLog("Primitives_project_culling.....: "+ProBar(stat.primitives_back_face_culling,status)+" "+stat.primitives_project_culling+"\n");
     WriteToLog("Primitives renderd:............: "+ProBar(stat.primitives_renderd,stat.primitives_in)+" "+stat.primitives_renderd+"\n");
	 WriteToLog("Spans_in:......................: "+stat.spans_in+"\n");
     WriteToLog("Spans_out:.....................: "+stat.spans_out+"\n");
	


  

	
}

function Update() {
	WriteToLog("\b");
	this.UpdateKeys();
	this.UpdateMouse();

}



function requestAnimFrame() {

  if(!lastCalledTime) {
     lastCalledTime = Date.now();
     fps = 0;
     return;
  }
  delta = (Date.now() - lastCalledTime)/1000;
  lastCalledTime = Date.now();
  fps = 1/delta;
}
  
function TestRender()
{
	if (bsp==null) return;
	for (let leaf of bsp._leafs) {
		let c0=leaf._aabb.center();
		for (let portal of leaf._portals)
		{
			let c1=portal.center();
			rasterizer.DrawLine3D(c0,c1);

		}
	}
}

function GameLoop() {
  
	
	Update();
	rasterizer.Start(cam);
	Render();
	//TestRender();
	if (m_render_zbuffer) {
   	   rasterizer.ZBufferToScreenOLD();	
	}
	
	
	canvas.Redraw();
	

canvas.flip();
requestAnimFrame();
    
}



function myTimer() {

    // --- Frame rendern ---
meter.tickStart();
	// ... rendering happens here ...
	
    GameLoop();
 meter.tick();
  //  requestAnimationFrame(myTimer);
}





function AddLineBrush(v0,v1,scale=1,prims)
{
	let ray= new Ray(3);
	ray.calc(v0,v1);
    let p0  = new Portal(ray,scale);
    let pm0 = new Polygon(p0.verts,true);
    let pm1 = new Polygon(p0.verts);
	let l=v1.sub(v0).length();
    
    pm0.calcPlane();
	pm0.SetColor(1,0,0);
	prims.push(pm0);
	
    
	let pm2= new Polygon(pm0);

	for (let p of pm2.verts) {
		p._world=p.world.add(ray.normal.mul(l));
	}	
    pm2.calcPlane();
	pm2.SetColor(0,1,0);
    prims.push(pm2);

return;	
   let vv0=new Array(pm1.verts[0].world,pm1.verts[1].world,pm2.verts[1].world,pm2.verts[0].world)
   let pm3 = new Polygon(vv0);
   pm3.calcPlane();
   pm3.SetColor(0,0,1);
   prims.push(pm3);

   {
   let vv0=new Array(pm1.verts[1].world,pm1.verts[2].world,pm2.verts[2].world,pm2.verts[1].world)
   let pm3 = new Polygon(vv0);
   pm3.calcPlane();
   pm3.SetColor(1,0,0);
   prims.push(pm3);
   }

   {
   let vv0=new Array(pm1.verts[2].world,pm1.verts[3].world,pm2.verts[3].world,pm2.verts[2].world)
   let pm3 = new Polygon(vv0);
   pm3.calcPlane();
   pm3.SetColor(1,0,1);
   prims.push(pm3);
   }

   {
   let vv0=new Array(pm1.verts[3].world,pm1.verts[0].world,pm2.verts[0].world,pm2.verts[3].world)
   let pm3 = new Polygon(vv0);
   pm3.calcPlane();
   pm3.SetColor(0,1,1);
   prims.push(pm3);
   }


}

function AddLines(leafs,prims) {
	//	AddLineBrush(new Vector3(1,0,0),new Vector3(0,1,0),0.05,prims)    



	  for (let l of leafs)
	  {
          let lc = l._aabb.center();
	
		  for (let p of l._portals) {
            let pc=p.center();

			AddLineBrush(lc,pc,0.05,prims)
  		  }
	  }

}


function ReadMapFromString() {
  DebugOut("Reset Rasterizer\n");	
  rasterizer.Reset();
  DebugOut("Read Mapfile\n");	
  var text=    document.getElementById("mapsource").value;
  var mapparser= new MAPParser();
  var map =mapparser.LoadMapFromString(text);
  
 
  DebugOut("Ready\n");	
  
   
 
  let brush_list=map.GetBrushList();


  polylist= map.ConvertToPolygonlist();

  console.log("Polygons bevor csg "+polylist.length)
   
    
  CSG.union(brush_list)
  
  polylist= new Array();



  for (let b of brush_list) {
	for (p of b.primitives) {
		let pp=new Polygon(p,false,1);
		pp.render_type=POLY_PERSPECTIVE_TEXTURED;
		polylist.push(pp);
	}
  }



  let aabb= new AABB(polylist);
  let polylist2=aabb.BuildPolygons(2);
  for (let p of polylist2) polylist.push(p);
  bsp=new BSPTree(polylist); 
  DebugOut(bsp.DebugTree()+"\n");

  let portals=PortalBuilder.BuildPortals(bsp);
 NonVisPolygonsRemover.Remove(bsp) 
  let outprims=bsp.ExtractPrims();

 

  for (let p of portals) {
	let pp=new Polygon(p.verts);
	pp.SetColor(1,0,0);
//	outprims.push(pp);
  }

	rasterizer.AddPrimitive(outprims);
 

//	rasterizer.AddPrimitive(bsp._leafs[25]._prims)
 rasterizer.BuildBSP();
 
}


function Init() {


     let v0=new Array(new Vector3(0,0,0),new Vector3(10,0,0),new Vector3(10,10,0));

    



	canvas.Canvas.addEventListener("mouseleave", (event) => {
		mouse_key=0;

	});

	canvas.Canvas.addEventListener("mousemove", (ev) => {
        let cols = canvas.width;
        let { offsetX, offsetY } = ev;
        
		SetMousePos(offsetX,offsetY);
        if (!use_timer)  GameLoop();
      });
      
	  canvas.Canvas.addEventListener("mousedown", (e) => {
		switch (e.button) {
		  case 0:
			mouse_key |=MOUSE_BUTTON_LEFT;
			break;
		  case 1:
			mouse_key |=MOUSE_BUTTON_MIDDLE;
			break;
		  case 2:
			//mouse_key |=MOUSE_BUTTON_RIGHT;
			break;
		  default:
			break;
		}
	  });

	  canvas.Canvas.addEventListener("mouseup", (e) => {
		
		switch (e.button) {
		  case 0:
			mouse_key &=~MOUSE_BUTTON_LEFT;
			break;
		  case 1:
			mouse_key &=~MOUSE_BUTTON_MIDDLE;
			break;
		  case 2:
			//mouse_key &=~MOUSE_BUTTON_RIGHT;
			break;
		  default:
			break;
		}
	  });

	 
	 
	 
	  {
	   const checkbox = document.getElementById('use_spanbuffer_checkbox')
  	         checkbox.checked=rasterizer._use_spanbuffer;  
	         checkbox.addEventListener('change', (event) => {
              rasterizer._use_spanbuffer=event.currentTarget.checked;
         })
	  }

        
	 
	 
	 
	  {
	   const checkbox = document.getElementById('use_node_frustum_culling')
  	         checkbox.checked=rasterizer._use_node_frustum_culling;  
	         checkbox.addEventListener('change', (event) => {
              rasterizer._use_node_frustum_culling=event.currentTarget.checked;
         })
	  }

	 
	  {
	   const checkbox = document.getElementById('use_node_hzbuffer_culling')
  	         checkbox.checked=rasterizer._use_node_hzbuffer_culling;  
	         checkbox.addEventListener('change', (event) => {
              rasterizer._use_node_hzbuffer_culling=event.currentTarget.checked;
         })
	  }
     {
	   
		const checkbox = document.getElementById('use_timer');
  	         checkbox.checked=use_timer;  
	         checkbox.addEventListener('change', (event) => {
              use_timer=event.currentTarget.checked;
			  if (use_timer)   setInterval(myTimer, 30);
         })
	  }

	 
	
	

	
	{
	 
	 
	   const checkbox = document.getElementById('render_zbuffer_checkbox')
	   checkbox.checked=m_render_zbuffer;

	    checkbox.addEventListener('change', (event) => {
           m_render_zbuffer=event.currentTarget.checked;
         })
	}



	  //obj3d
   



   for (let i=0;i<256;i++) {keys[i]=false; prekeys[i]=false;}


   
   canvas.Clear();


   InitCamera();
/*
   let s=3;
 for (let z=-s;z<s;z++)
   for (let y=-s;y<s;y++)  
   for (let x=-s;x<s;x++) {

     var p=CreateCube(new Vector3(x*4,y*4,z*4),POLY_PERSPECTIVE_TEXTURED) 
     for (let i=0;i<p.length;i++) rasterizer.AddPrimitive(p[i]);
   }

 
  
	{
	 let obj=OBJLoader.parseFromString(TEST);
	 let p=OBJLoader.buildPolygons(obj);
     for (let i=0;i<p.length;i++) rasterizer.AddPrimitive(p[i]);
	}
*/
	   //rasterizer.BuildBHV();
	  // rasterizer.BuildBSP();

  //  meter = new FPSMeter();


   //var p=CreateCube(new Vector3(0,0,0),POLY_PERSPECTIVE_TEXTURED) 
   // for (let i=0;i<p.length;i++) rasterizer.AddPrimitive(p[i]);

  
   let vv=Array(new Vector3(-5,-5,0),new Vector3(5,-5,0),new Vector3(5,5,0),new Vector3(-5,5,0));
   vv=vv.reverse();
   let portal=new Portal(vv);

      let poly=new Polygon(portal.verts);  
   poly.render_type=POLY_PERSPECTIVE_TEXTURED;
   poly.calcPlane();
   poly.setWorldTexture(0.01,0.01);

  // rasterizer.AddPrimitive(poly);



   let aabb=new AABB(new Vector3(-1,-1,-1),new Vector3(1,1,1));
   //let p=aabb.ClipPortal(portal)
   portal=aabb.ClipPortal(portal);

   

   
   poly=new Polygon(portal.verts);  
   poly.render_type=POLY_PERSPECTIVE_TEXTURED;
   poly.calcPlane();
   poly.setWorldTexture(0.1,0.1);

   rasterizer.AddPrimitive(poly);
	
  
 
   poly=aabb.BuildPolygons();
   for (let p of poly) {
     p.render_type=POLY_PERSPECTIVE_TEXTURED;
     p.calcPlane();
     p.setWorldTexture(0.1,0.1);
     rasterizer.AddPrimitive(p);

   }



   rasterizer.BuildBVH();
 
 
   meter = new FPSMeter(document.getElementById('target'), { graph: 2,heat: 1 });
   if (use_timer)   setInterval(myTimer, 30);
   
}


window.addEventListener("keydown", function(event) {
	if (event.defaultPrevented) {
	  return;
	}
   //console.log(event.keyCode);
   prekeys[event.keyCode]=keys[event.keyCode];
   keys[event.keyCode]=true;

   m_last_key_down=event.keyCode;
	switch (event.keyCode) {
        default: break;
	};

	event.preventDefault();
	if (!use_timer)  GameLoop();
	
  }, true);

  window.addEventListener("keyup", function(event) {
	if (event.defaultPrevented) {
	  return;
	}
	prekeys[event.keyCode]=keys[event.keyCode];

	keys[event.keyCode]=false;
	switch (event.keyCode) {
        default: break;
	};

	event.preventDefault();
  }, true);


  window.onload = Init;

 
  